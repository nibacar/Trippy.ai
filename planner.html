<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trippy — Route Planner with Attractions</title>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f3f4f6; color:#111827; }
    .container { max-width: 1100px; margin: auto; padding: 16px; }
    .planner-inline { display: flex; gap: 10px; background: #fff; padding: 14px; border-radius: 20px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #d9dce3; background:#fff; cursor: pointer; font-weight: bold; }
    button.primary { background: #111; color: #fff; border-color:#111; }
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-top:16px; }
    #map { width: 100%; height: 500px; border-radius: 20px; overflow:hidden; }
    #panel { background: #fff; padding: 14px; border-radius: 20px; height: 500px; overflow-y: auto; border:1px solid #e6e8ee; }
    h1 { margin: 0 0 12px; font-size: 24px; }
    h3 { margin: 8px 0; }
    .muted { color:#6b7280; }
    .attraction { border: 1px solid #e6e8ee; padding: 10px; border-radius: 12px; margin-top: 10px; background:#fafbff; }
    .title-row { display: flex; justify-content: space-between; align-items:center; gap:10px; }
    .itinerary { margin-top: 10px; }

    /* ▼ NEW: bottom itinerary box */
    .itinerary-bar {
      margin-top: 16px;
      background:#fff;
      border:1px solid #e6e8ee;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
      padding:12px;
    }
    .itinerary-bar__head {
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e6e8ee; background:#f9fafb; color:#374151; font-size:12px; }
    .itinerary-bar__list { display:grid; gap:8px; }
    .itinerary-bar__row {
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px;
      border:1px solid #eef1f6; border-radius:10px; background:#fff;
    }
    .nowrap { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Plan Your Road Trip</h1>
    <div class="planner-inline">
      <input id="startInput" placeholder="Starting point" />
      <input id="destInput" placeholder="Destination" />
      <button id="goBtn" class="primary">Go</button>
    </div>

    <div class="grid">
      <div id="map"></div>
      <div id="panel">
        <h3>Attractions</h3>
        <div id="attractionsList" class="muted">Enter a route...</div>
        <h3>Itinerary</h3>
        <div id="itineraryList"></div>
      </div>
    </div>

    <!-- ▼ NEW: bottom itinerary control box -->
    <div class="itinerary-bar" id="itineraryBar" aria-live="polite">
      <div class="itinerary-bar__head">
        <div>
          <strong>Selected Stops</strong>
          <span class="pill" id="itCountBottom">0 selected</span>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="clearAllBtn">Reset all</button>
        </div>
      </div>
      <div class="itinerary-bar__list" id="itineraryBarList">
        <div class="muted">No stops yet — add some from the “Attractions” list.</div>
      </div>
    </div>
    <!-- ▲ NEW -->
  </div>

  <script>
    let map, directionsService, renderer;
    let routeOrigin, routeDest;

    // Core state
    let selectedStops = [];             // [{ name, lat, lng }]
    const selectedKeys = new Set();     // prevent duplicates

    function makeKey(name, lat, lng){
      return `${(name||'').toLowerCase().trim()}|${(+lat).toFixed(5)},${(+lng).toFixed(5)}`;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: 39.5, lng: -98.35},
        zoom: 4
      });
      directionsService = new google.maps.DirectionsService();
      renderer = new google.maps.DirectionsRenderer({ map: map });

      document.getElementById("goBtn").addEventListener("click", planRoute);

      // NEW: Reset-all button
      document.getElementById("clearAllBtn").addEventListener("click", clearAllStops);
    }

    async function planRoute() {
      const start = document.getElementById('startInput').value.trim();
      const dest = document.getElementById('destInput').value.trim();
      if (!start || !dest) { alert("Enter both start and destination"); return; }

      const route = await directionsService.route({
        origin: start,
        destination: dest,
        travelMode: 'DRIVING'
      });
      renderer.setDirections(route);

      const leg = route.routes[0].legs[0];
      routeOrigin = leg.start_location;
      routeDest = leg.end_location;

      fetchAttractions(leg.start_address, leg.end_address);
    }

    async function fetchAttractions(origin, destination) {
      const list = document.getElementById('attractionsList');
      list.innerHTML = "Loading attractions...";

      try {
        const res = await fetch("http://localhost:5001/api/attractions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ origin, destination })
        });

        if (!res.ok) {
          const t = await res.text();
          list.innerHTML = "Failed to load attractions.";
          console.error("Backend error:", t);
          return;
        }

        const data = await res.json();

        if (!data.attractions || data.attractions.length === 0) {
          list.innerHTML = "No attractions found.";
          return;
        }

        list.innerHTML = "";
        data.attractions.forEach((a) => {
          const div = document.createElement('div');
          div.className = "attraction";

          const btn = document.createElement('button');
          btn.textContent = 'Add';
          btn.addEventListener('click', () => addToItinerary(a.lat, a.lng, a.name));

          const top = document.createElement('div');
          top.className = 'title-row';
          const nameEl = document.createElement('strong');
          nameEl.textContent = a.name;

          top.appendChild(nameEl);
          top.appendChild(btn);

          const meta = document.createElement('div');
          meta.textContent = `⭐ ${a.rating ?? "N/A"} • ${a.distanceFromRouteKm}km off route`;

          div.append(top, meta);
          list.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        list.innerHTML = "Could not reach backend.";
      }
    }

    // ▼ Updated: now prevents duplicates and updates both the panel and the new box
    function addToItinerary(lat, lng, name) {
      const key = makeKey(name, lat, lng);
      if (selectedKeys.has(key)) {
        // Already added — do nothing
        return;
      }
      selectedKeys.add(key);
      selectedStops.push({ lat, lng, name });

      renderPanelItinerary();
      renderBottomItinerary();
      rerouteWithStops();
    }

    // NEW: remove a single stop by index
    function removeStop(index){
      const item = selectedStops[index];
      if (!item) return;
      const key = makeKey(item.name, item.lat, item.lng);
      selectedKeys.delete(key);
      selectedStops.splice(index, 1);

      renderPanelItinerary();
      renderBottomItinerary();
      rerouteWithStops();
    }

    // NEW: reset all
    function clearAllStops(){
      selectedStops = [];
      selectedKeys.clear();
      renderPanelItinerary();
      renderBottomItinerary();
      rerouteWithStops();
    }

    // Rebuild the right-panel itinerary (keeps original minimal look)
    function renderPanelItinerary(){
      const itList = document.getElementById('itineraryList');
      itList.innerHTML = "";
      selectedStops.forEach((s) => {
        const item = document.createElement('div');
        item.textContent = s.name; // same simple look as before
        itList.appendChild(item);
      });
    }

    // Build the bottom box with remove buttons + count
    function renderBottomItinerary(){
      const countEl = document.getElementById('itCountBottom');
      const listEl  = document.getElementById('itineraryBarList');

      countEl.textContent = `${selectedStops.length} selected`;

      if (selectedStops.length === 0){
        listEl.innerHTML = '<div class="muted">No stops yet — add some from the “Attractions” list.</div>';
        return;
      }

      listEl.innerHTML = "";
      selectedStops.forEach((s, i) => {
        const row = document.createElement('div');
        row.className = "itinerary-bar__row";

        const left = document.createElement('div');
        left.className = "nowrap";
        left.textContent = `${i+1}. ${s.name}`;

        const rm = document.createElement('button');
        rm.textContent = "Remove";
        rm.addEventListener('click', () => removeStop(i));

        row.append(left, rm);
        listEl.appendChild(row);
      });
    }

    function rerouteWithStops() {
      if (!routeOrigin || !routeDest) return;
      const waypoints = selectedStops.map(s => ({
        location: new google.maps.LatLng(s.lat, s.lng), stopover: true
      }));
      directionsService.route({
        origin: routeOrigin,
        destination: routeDest,
        waypoints: waypoints,
        travelMode: 'DRIVING'
      }, (resp) => renderer.setDirections(resp));
    }
  </script>

  <!-- Use your browser-safe Maps JS key here -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_BROWSER_API_KEY&callback=initMap" async defer></script>
</body>
</html>
